
# 游戏初始化

下面把「游戏管理 → 新增游戏 → 初始化配置」这一整条交互链路中**所有弹窗、Toast、文字提示**梳理成一张「**交互清单**」。  
已按出现顺序归类，方便后续由前端、QA、运营直接对照实现与验收。  

---

### 1. 入口弹窗：新增游戏  
| 触发 | 元素 | 文案/交互 | 备注 |
|---|---|---|---|
| 点击【添加游戏】按钮 | 弹窗标题 | 添加游戏 | 一级弹窗 |
|  | 输入框① | APP ID<br>占位符：请输入appid | 必填，校验规则见下 |
|  | 输入框② | 描述<br>占位符：请输入游戏描述 | 非必填 |
|  | 开关① | 客户端资源 | 默认关；开启后出现“已配置”字样 |
|  | 开关② | 服务端资源 | 默认关；开启后出现“已配置”字样 |
|  | 开关③ | 全球加速<br>副文案：启用全球加速 | 默认关 |
|  | 开关④ | flashlaunch<br>副文案：启用flashlaunch | 默认关 |
|  | 按钮 | 取消 / 确认 | 确认后进入「初始化配置」 |

---

### 2. 表单校验弹窗 / Toast  
| 触发 | 类型 | 文案 | 自动关闭 |
|---|---|---|---|
| APP ID为空 | Toast | APP ID不能为空 | 2s |
| APP ID已存在 | Toast | 该APP ID已存在，请重新输入 | 2s |
| 至少未开启客户端/服务端任一 | Toast | 请至少开启“客户端资源”或“服务端资源” | 2s |

---

### 3. 初始化确认弹窗  
| 触发 | 元素 | 文案/交互 | 备注 |
|---|---|---|---|
| 点击【确认】且校验通过 | 二级弹窗标题 | 初始化配置 | 二次确认 |
|  | 提示正文 | 一旦初始化完成，以下信息**不可修改**：<br>• APP ID<br>• 客户端资源<br>• 服务端资源<br>• 全球加速<br>• flashlaunch | 红色警示 |
|  | 复选框 | 我已知晓并确认 | 必须勾选才能点“确定开启” |
|  | 按钮 | 取消 / **确定开启** | 点击后进入后台初始化任务 |

---

### 4. 初始化进行中的 Toast / Loading  
| 触发 | 类型 | 文案 | 自动关闭 |
|---|---|---|---|
| 点击【确定开启】后 | Toast | 正在初始化，请稍候… | 常驻，直到收到成功/失败回调 |

---

### 5. 初始化结果反馈  
| 结果 | 类型 | 文案 | 后续动作 |
|---|---|---|---|
| 成功 | Toast | 初始化成功 | 2s后关闭，返回列表页，状态列显示“已完成初始化” |
| 失败 | 弹窗 | 初始化失败<br>原因：{后端返回错误信息} | 点击“确定”关闭弹窗，保留原表单内容，可再次提交 |

---

### 6. 列表页状态提示 & 二次操作确认  
| 场景 | 元素 | 文案/交互 | 备注 |
|---|---|---|---|
| 列表页状态列 | 标签 | 已完成初始化 | 绿色文字 |
| 列表页状态列 | 标签 | 未初始化 | 灰色文字 |
| 列表页【删除】按钮 | 二次确认弹窗 | 删除后不可恢复，是否继续？ | 取消/确认 |

---

### 7. 全局异常兜底提示  
| 触发 | 类型 | 文案 | 自动关闭 |
|---|---|---|---|
| 接口超时/500 | Toast | 网络异常，请稍后重试 | 2s |

---

### 附：交互流程图（文字版）

```
【添加游戏】
   │
   ├─> 表单校验
   │     ├─ 空/重复 → Toast提示
   │     └─ 通过 → 初始化确认弹窗
   │
   ├─> 二次确认弹窗
   │     ├─ 取消 → 返回表单
   │     └─ 确认 → 调用初始化接口
   │
   ├─> Loading Toast
   │
   ├─> 成功/失败反馈
   │     ├─ 成功 → 列表页刷新，显示“已完成初始化”
   │     └─ 失败 → 弹窗提示，可重试
   │
   └─> 列表页删除（二次确认）
```

---

如需进一步将以上清单转为 PRD 或前端任务单，可直接按「触发-类型-文案-动作」四列输出表格即可。

## 游戏管理业务规则

**特殊处理**

* 删除APP ID
  * 未进行初始化，可执行删除操作
  * 已初始化的APP，删除操作置灰
* 修改客户端/服务端配置
  * 已初始化：点击toast提示“已完成初始化，不可修改”
  * 未初始化：点击弹窗确认是否修改配置，确认后完成修改
* 全球加速
  * 开启：点击toast提示“开启后无法关闭”
  * 关闭：点击弹窗确认是否开启，确认后完成修改
* flashlaunch
  * 点击弹窗确认是否修改配置，确认后完成修改

  

#### 添加游戏


1. 操作入口：admin管理页面-平台游戏
2. UI交互：

   
   1. 点击”添加“icon，出现添加游戏弹窗，输入以下内容

      
      1. APP ID：必填
      2. 描述：非必填，针对游戏的描述说明
      3. 客户端资源：**切换开关**，默认打开，（已勾选之后且初始化成功后不可取消）
      4. 服务端资源：**切换开关**，默认打开，（已勾选之后且初始化成功后不可取消）
      5. 全球加速：勾选项，默认不勾选（开启后不可关闭）==已确认==
      6. flashlaunch：勾选项，默认勾选（初始化后可修改）
   2. 可选操作：

      
      1. 确定：保存配置
      2. 关闭：退出配置界面

**添加游戏成功的必要条件：服务端和客户端资源至少配置一项**

**未配置客户端的情况下，不可开启全球加速和flashlaunch，提示“未配置客户端资源、无法开启”**

#### 删除游戏

对于完全未进行初始化的游戏，可执行”删除“操作，


1. 操作入口：admin管理页面-平台游戏
2. UI交互：

   
   1. 点击”删除“，弹出确认框提示”删除后数据不可恢复，是否删除“， 

      
      1. 可选操作：

         
         1. 确定：删除游戏
         2. 关闭：退出当前确认界面
      2. 游戏删除后CP不可在publisher 页面搜索到该ID


### 4.2 publisher 游戏初始化



1. 操作入口：平台游戏列表页-初始化
2. UI交互：

   
   1. 搜索APPID，根据admin选择的客户端和服务端配置，分模块初始化
   2. 客户端 展示“S3 和CDN 尚未初始化，请点击初始化按钮执行操作”
   3. 服务端展示“K8S 配置尚未初始化，请点击初始化按钮执行操作”
   4. 点击执行初始化操作后，展示初始化进度条


**说明**

* 游戏初始化为异步操作，关闭当前初始化窗口后再次打开，仍展示初始化进度
* 若初始化失败，进度条可点击“重试”按钮，从失败位置重新初始化
* 日志记录 cp 初始化操作




# 资源配置

以下把「**游戏资源配额配置页**」中出现的所有**按钮、弹窗、Toast、输入校验、状态提示**等交互元素，按出现顺序整理成一张「交互清单」。  
可直接用于 PRD、前端任务单或 QA 用例。

---

### 1. 列表页（Game Resource Quota List）

| 区域/元素 | 文案/交互 | 备注 |
|---|---|---|
| 页面标题 | 仓游戏管理 / 初始化配置 | 面包屑导航 |
| 搜索框 | 请输入 appid | 实时过滤，支持模糊匹配 |
| 列表表头 | appid / 应用资源CPU核数 / MySQL实例数量 / Mongo实例数量 / Redis实例数量 / Zookeeper实例数量 / 操作 | 固定顺序 |
| 列表行 | 示例：gamedemo / 2 C / 1 / 1 / 1 / 1 / 【修改配额】 | 每行对应一个 appid |
| 空列表提示 | 暂无数据 | 当过滤结果为空时 |

---

### 2. 点击【修改配额】→ 打开「应用资源配额」弹窗

| 弹窗标题 | 应用资源配额 |
|---|---|

#### 2.1 表单字段（全部必填）

| 字段 | 类型 | 默认值 | 校验规则 |
|---|---|---|---|
| CPU最大核数 | 数字输入框 | 当前行值 | 1–64（整数）；>0 |
| Mongo实例数量 | 数字输入框 | 当前行值 | 0–10（整数）；≥0 |
| MySQL实例数量 | 数字输入框 | 当前行值 | 0–10（整数）；≥0 |
| Redis实例数量 | 数字输入框 | 当前行值 | 0–10（整数）；≥0 |
| Zookeeper实例数量 | 数字输入框 | 当前行值 | 0–10（整数）；≥0 |

#### 2.2 按钮

| 按钮 | 交互 | 备注 |
|---|---|---|
| 取消 | 关闭弹窗，不保存任何修改 | 键盘 Esc 也可触发 |
| 确认 | 先前端校验，再调用接口 | 校验失败则给出 Toast |

---

### 3. 前端校验 Toast（即时）

| 触发条件 | Toast 文案 | 自动关闭 |
|---|---|---|
| 任一字段为空 | 请完整填写所有配额 | 2 s |
| 任一字段非整数 | 请输入整数 | 2 s |
| 任一字段超出范围 | CPU核数需在 1–64 之间 | 2 s |
| 任一实例数量为负 | 实例数量不能为负数 | 2 s |

---

### 4. 调用接口后的反馈

| 结果 | 类型 | 文案 | 后续动作 |
|---|---|---|---|
| 成功 | Toast | 配额修改成功 | 2 s 后关闭，列表页自动刷新对应行 |
| 失败 | 弹窗 | 配额修改失败<br>原因：{后端错误信息} | 点击“确定”关闭弹窗，保留弹窗内已填数据，可再次提交 |

---

### 5. 特殊边界提示（运营/技术支持常见）

| 场景 | 提示 | 触发时机 |
|---|---|---|
| 配额超限 | 弹窗：当前租户剩余 CPU 额度不足，请联系管理员提升额度 | 后端返回 403/409 |
| 关键实例数量设为 0 | 二次确认弹窗：将 MySQL/Redis 实例数设为 0 可能影响线上功能，是否继续？ | 当对应字段从 ≥1 改为 0 时 |

---

### 6. 交互流程图（文字版）

```
列表页 → 点击【修改配额】
            │
            ├─> 弹窗展示当前配额
            │      ├─ 用户修改数值
            │      ├─ 前端即时校验
            │      │     ├─ 不通过 → Toast
            │      │     └─ 通过 → 点击【确认】
            │      │
            │      └─> 调用接口
            │              ├─ 成功 → Toast + 列表刷新
            │              └─ 失败 → 弹窗错误提示
            │
            └─> 点击【取消】或 Esc → 关闭弹窗，无保存
```

---

### 7. 可一键落地的任务单模板（示例）

| 功能 | 触发 | 预期结果 | 优先级 |
|---|---|---|---|
| 修改配额弹窗-CPU校验 | 输入 0 并确认 | Toast：CPU核数需在 1–64 之间 | P0 |
| 修改配额接口-失败 | 返回 500 | 弹窗展示错误文案，可重试 | P0 |
| 空列表占位 | 搜索无结果 | 展示“暂无数据”占位图 | P1 |

---

# 测试初始化

管理台再新增一个页面，页面叫”测试初始化“，页面上有两张卡片，卡片标题分别为”客户端初始化“和”服务端初始化“；
- 客户端 展示“S3 和CDN 尚未初始化，请点击初始化按钮执行操作”
- 服务端展示“K8S 配置尚未初始化，请点击初始化按钮执行操作”
点击初始化后，将游戏初始化的弹窗UI同步过来，客户端初始化，则初始化内容为”客户端“，若服务端初始化，则初始化内容为”服务端“，若在游戏管理没有配置客户端或服务端，弹窗展示内容”无相应配置项，请联系平台SRE配置“


# 新增游戏下线逻辑

游戏增加一个操作“下线”
- 已完成初始化的游戏才能执行“下线”操作，否则操作置灰
- 点击“下线”，二次弹窗确认，游戏下线不可取消，下线后将清理所有资源，请谨慎操作，需要勾选”我已知悉风险“，才能点击确认执行
- 操作不可撤销
- 下线时需要执行资源清理操作，清理的资源如下

* **下线需要清理资源**

AliCloud
- OSS
  - Empty Bucket
  - Delete Bucket
- RAM
  - Delete Access Keys
  - Delete Policies（获取策略版本信息，先删除版本再删除策略）
  - Delete UserDelete User
- ACR NS
  - Delete namespace(前置 pv、pvc清理动作。为规避 finalizers 前置清除机制，需要置空）
- Tair(Redis)
  - Get Instance List By Tag
  - Trigger Transform ChargeType （PrePaid → PostPaid）
  - Polling for instance Conversion Status（Interval 10s, Retry 10）
  - Delete Instance
- PV & PVC
  - Get all PVCs in the namespace
Get all PVs in the cluster
Filter PVs that are related to the current namespace
Delete PVCs
Delete PVs
Delete mount points by app(放在清理 App Relation Data 中）
ACK NameSpace
需要先行清理PV&PVC
PolarDB
PRD(Cluster)
Get cluster by tag
Transform charge type
Async poll for conversion status
Delete cluster
STG(DB)
Get version by db 
Get stg cluster info
Get database by appID
Filter database by appID
Trigger delete database
Mongo
PRD
MSE
Get gateway domain
Delete gateway domain
Delete by env
SHARED
Get ingress by namespace
Delete ingress by appID & ingress name
Gateway Instance
Delete gateway
Get ingress configs
Delete ingress config
Delete ingress class
GA
Get GAs by tag
Trigger delete GA
AWS
CloudFront
根据cdns表中的DistributionID 数据获取 ETag
禁用 Distribution
Delete Distribution
S3
Empty Bucket
Delete Bucket
IAM
Delete Access-Key
Delete Policies
Delete User
Route53
Get records by name
Delete traffic policy instance 
Delete records
Delete traffic policy



- 当某一步清理失败时，后续清理任务将暂停执行，直到前一步任务重试并成功完成后，才会继续执行下一步。
- 下线时需要弹窗展示日志，日志信息是每个资源的清理情况，点击弹窗可以关闭，关闭后“下线”操作变成“查看日志”，点击“查看日志”可继续查看弹窗内资源清理情况
- 资源完全清理后，游戏变成“下线”状态，这个时候才能点击“删除”按钮，出现删除确认弹窗，删除游戏


# 游戏管理逻辑补充
- 添加游戏（src/components/Admin/GameManagement.tsx 的“添加游戏”表单）
提交前校验：clientResource || serverResource 至少一个为 true，否则拦截提交并 message.error('请至少选择客户端或服务端资源')。

- 通用联动
若 globalAcceleration === true，则“客户端资源”不可被关闭（禁止将 clientResource 从 true 切为 false）。UI：Switch disabled 或在 onChange 内阻断并提示“已开启全球加速，不可取消客户端”。
当尝试将 globalAcceleration 从 false 切为 true 而客户端为 false 时，阻断并提示“开启全球加速需要先开启客户端资源”。

- 未初始化环境（env.initStatus !== 'initialized'）
clientResource、serverResource 可自由开关。
globalAcceleration 可开可关。若开启则自动校验客户端已开启；若已开启则允许再次关闭。

- 已初始化环境（env.initStatus === 'completed'）
客户端/服务端：
当前为 true：不可关闭（Switch disabled），Tooltip：「环境已初始化，资源项不可修改」。
当前为 false：允许开启（单向开启）。
全球加速：
当前为 true：不可关闭（Switch disabled），Tooltip：「已初始化且已开启全球加速，无法关闭」。
当前为 false：允许开启；一旦开启即视为“已开启且不可关闭”（切到 true 后立即禁用该开关）。
同时沿用前置校验：开启全球加速前，客户端必须为 true；若已开启全球加速，客户端不可被关闭，提示「已开启全球加速，不可取消客户端」。

- 点击测试环境或测试环境，配置弹窗的数据开启来自模拟数据，修改配置后，点击“确定”，才会更新数据
- 你可以新增一个表，记录每次配置修改后的值，首次的值来自模拟数据，后续被修改后则单独记录