## 需求说明文档（整合版）

### 项目背景
为了提升用户体验和信息传达的效率，需要对现有的系统公告功能进行优化和扩展。新增字段和功能将帮助用户更清晰地定义公告的性质和展示方式，并支持Markdown格式的内容输入与预览。

### 功能需求

列表字段：
标题
内容
状态
通知方式
通知类型
时间
操作：编辑、发布、删除

#### 1. 新增字段
在新建公告时，需要新增以下字段：

标题：1-24字符
内容：2560字符内
通知方式：默认为中间弹窗
通知类型：默认为系统公告
内容：md 格式内容，支持预览

#### 2. Markdown格式支持
- **输入支持**：在“通知内容”字段中，用户可以输入Markdown格式的文本。
  - **字段类型**：文本区域
  - **字段长度**：不限
  - **是否必填**：是
  - **默认值**：无
- **预览功能**：在输入Markdown内容后，用户可以点击预览按钮查看格式化后的展示效果。
  - **操作类型**：按钮
  - **操作描述**：点击后展示Markdown内容的预览效果



#### 4. 操作流程
1. 用户点击“新建公告”按钮。
2. 在弹出的新建公告窗口中，填写“标题”、输入“通知内容”。
3. 用户点击“预览”按钮，查看公告的格式化效果。
4. 用户确认无误后，点击“确认”按钮发布公告。

发布后，系统内模拟发送效果，页面中心位置出现弹窗，展示通知标题及内容

---

## 实现状态更新

### 已完成功能

基于上述需求，已在 `src/components/Admin/Announcement.tsx` 中完成以下功能实现：

#### 1. 公告管理页面结构
- **列表页面**：默认展示所有公告的列表视图
- **新建页面**：点击"新建公告"进入表单填写模式
- **预览功能**：支持 Markdown 渲染预览
- **发布流程**：二次确认发布机制

#### 2. 数据字段完整实现

**列表展示字段：**
- 标题（必填，1-24字符限制）
- 通知方式（选项：中间弹窗、顶部横幅、右下角弹窗）
- 通知类型（选项：系统公告、告警）
- 状态（已发布/未发布）
- 发布时间（发布后自动记录）
- 操作（预览、编辑、发布）

**表单字段：**
- 标题：Input 组件，支持 1-24 字符验证
- 通知方式：Select 组件，默认值为"中间弹窗"
- 通知类型：Select 组件，默认值为"系统公告"
- 内容：TextArea 组件，支持 Markdown 格式，最大 2560 字符

#### 3. Markdown 支持
- **渲染引擎**：内置简易 Markdown 渲染器，支持：
  - 标题（H1-H6）
  - 粗体、斜体文本
  - 行内代码
  - 超链接
  - 无序列表
  - 段落与换行
- **预览功能**：
  - 表单预览：显示标题 + 内容的完整渲染效果
  - 列表预览：支持从列表直接预览已保存的公告

#### 4. 操作流程实现

**新建公告流程：**
1. 点击"新建公告"按钮进入表单模式
2. 填写标题、选择通知方式和类型、输入 Markdown 内容
3. 可选操作：
   - **预览**：查看渲染后效果（包含标题）
   - **保存**：保存为草稿状态（未发布）
   - **发布**：打开预览弹窗进行二次确认
4. 发布确认后，公告状态变更为"已发布"，记录发布时间

**列表管理功能：**
- **预览**：查看公告的渲染效果
- **编辑**：重新编辑公告内容（仅限未发布状态）
- **发布**：对未发布公告进行发布操作（仅限未发布状态）
- **状态控制**：已发布公告的编辑和发布按钮自动置灰

#### 5. 交互细节
- **二次确认发布**：点击发布按钮后弹出预览窗口，显示完整内容供用户最终确认
- **状态管理**：发布后公告状态自动更新，防止重复发布或误操作
- **时间记录**：发布时自动记录精确的发布时间戳
- **响应式表格**：支持横向滚动，适配不同屏幕尺寸

### 技术实现要点

- **框架**：基于 Next.js + Ant Design 构建
- **状态管理**：使用 React useState 进行本地状态管理
- **数据持久化**：当前为前端模拟数据，便于原型验证
- **类型安全**：完整的 TypeScript 类型定义
- **代码质量**：通过 ESLint 检查，符合代码规范

### 演示数据

系统预置了 3 条示例公告数据：
1. **系统维护通知**（未发布状态）
2. **新活动上线**（已发布状态，含发布时间）
3. **小规模优化**（未发布状态）

### 访问路径

在管理后台（`/admin`）的左侧菜单中，点击"公告管理"即可访问完整功能。

---

## 功能优化更新

### 2024年新增需求实现

基于产品迭代需求，对公告管理功能进行了以下重要优化：

#### 1. 支持多次发布
- **需求背景**：允许同一公告多次发布，满足重要通知的重复推送需求
- **实现方式**：
  - 移除发布后按钮置灰限制
  - 新增 `publishHistory` 字段记录所有发布时间
  - 每次发布自动更新最近发布时间并追加到历史记录

#### 2. 发送范围控制
- **新增字段**：`gameScope`（游戏范围多选）
- **可选范围**：
  - 全部游戏
  - gamedemo
  - kumo  
  - slime
- **交互设计**：
  - 使用 Ant Design 的 `Select` 组件，设置 `mode="multiple"` 支持多选
  - 默认值为"全部游戏"
  - 必填字段，确保每条公告都有明确的发送范围

#### 3. 已发布公告可编辑
- **编辑权限**：已发布公告同样支持编辑操作
- **可编辑字段**：
  - 标题（title）
  - 内容（content）  
  - 发送范围（gameScope）
- **保护机制**：编辑已发布公告时保留原有发布历史和状态

#### 4. 界面优化
- **列表展示**：新增"发送范围"列，显示选中的游戏列表
- **表单优化**：
  - 表单标题根据操作类型动态显示（新建公告/编辑公告）
  - 发送范围字段位置调整到标题下方，突出重要性
- **操作逻辑**：
  - 编辑按钮始终可用（不再因发布状态置灰）
  - 发布按钮支持重复点击，实现多次发布

### 技术实现细节

#### 数据结构扩展
```typescript
interface AnnouncementItem {
  id: string
  title: string
  content: string
  method: string
  type: string
  status: '已发布' | '未发布'
  publishAt?: string
  gameScope: string[]           // 新增：发送范围
  publishHistory?: string[]     // 新增：发布历史记录
}
```

#### 关键功能实现
1. **编辑状态管理**：使用 `editingId` 状态区分新建和编辑模式
2. **多次发布逻辑**：发布时追加时间到 `publishHistory` 数组
3. **游戏范围选择**：使用 `gameOptions` 配置可选游戏列表
4. **表单数据同步**：编辑时自动加载现有数据到表单

### 用户操作流程更新

**编辑已发布公告流程：**
1. 在列表中点击任意公告的"编辑"按钮
2. 系统加载现有数据到编辑表单
3. 用户可修改标题、内容、发送范围
4. 保存后更新公告信息，保持原有发布状态
5. 可选择再次发布，系统记录新的发布时间

**多次发布流程：**
1. 对任意公告（包括已发布）点击"发布"
2. 系统弹出预览确认窗口
3. 确认后执行发布，更新最近发布时间
4. 发布历史自动记录，支持追溯所有发布时点

### 演示数据更新

更新了示例数据以展示新功能：
- **系统维护通知**：发送范围为"全部游戏"
- **新活动上线**：发送范围为"gamedemo, kumo"，包含发布历史
- **小规模优化**：发送范围为"slime"

这些优化使公告管理系统更加灵活和实用，满足了多样化的业务发布需求。
